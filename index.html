<!DOCTYPE html>
<html>
<head>
    <title>ESP32 Keyboard Control</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 20px;
        }

        .control-panel {
            max-width: 800px;
            margin: 20px auto;
            padding: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .status-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 30px;
        }

        .status-indicator {
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .status-indicator.connected {
            background: #e6f4ea;
            color: #34a853;
        }

        .status-indicator.disconnected {
            background: #fce8e6;
            color: #ea4335;
        }

        .doc-input {
            margin-bottom: 30px;
        }

        .doc-input input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
        }

        .speed-controls {
            text-align: center;
            margin-bottom: 30px;
        }

        .preset-btn {
            padding: 8px 20px;
            margin: 0 5px;
            border: none;
            border-radius: 20px;
            background: #f1f3f4;
            cursor: pointer;
            transition: background 0.3s;
        }

        .preset-btn:hover {
            background: #e8eaed;
        }

        .preset-btn.active {
            background: #4285f4;
            color: white;
        }

        .custom-speed {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        #wpm-input {
            width: 80px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
        }

        .progress-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .progress-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .progress-bar {
            height: 10px;
            background: #e8eaed;
            border-radius: 5px;
            overflow: hidden;
        }

        #progress-fill {
            height: 100%;
            background: #4285f4;
            width: 0%;
            transition: width 0.3s;
        }

        button#upload {
            display: block;
            width: 100%;
            padding: 12px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background 0.3s;
            margin: 20px 0;
        }

        button#upload:hover {
            background: #3367d6;
        }

        button#upload:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #upload-status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            display: none;
        }

        #upload-status.success {
            background: #e6f4ea;
            color: #34a853;
        }

        #upload-status.error {
            background: #fce8e6;
            color: #ea4335;
        }
    </style>
</head>
<body>
    <div class="control-panel">
        <h1>ESP32 Keyboard Control</h1>
        
        <div class="status-bar">
            <div id="wifi-status" class="status-indicator disconnected">WiFi: Disconnected</div>
            <div id="ble-status" class="status-indicator disconnected">Bluetooth: Disconnected</div>
            <div id="auth-status" class="status-indicator disconnected">Auth: Not Verified</div>
        </div>

        <div class="doc-input">
            <input type="text" id="doc-link" placeholder="Enter Google Doc link">
        </div>

        <div class="speed-controls">
            <div class="presets">
                <button class="preset-btn" onclick="setSpeed(20)">20 WPM</button>
                <button class="preset-btn" onclick="setSpeed(40)">40 WPM</button>
                <button class="preset-btn" onclick="setSpeed(60)">60 WPM</button>
                <button class="preset-btn" onclick="setSpeed(80)">80 WPM</button>
            </div>
            <div class="custom-speed">
                <label for="wpm-input">Custom WPM:</label>
                <input type="number" id="wpm-input" min="1" max="200" value="60">
            </div>
        </div>

        <button id="upload" onclick="uploadDoc()">Upload Document</button>
        <div id="upload-status"></div>

        <div class="progress-section">
            <div class="progress-stats">
                <div>Progress: <span id="progress-percent">0%</span></div>
                <div>Words Typed: <span id="words-typed">0</span></div>
            </div>
            <div class="progress-bar">
                <div id="progress-fill"></div>
            </div>
        </div>
    </div>

    <script>
        const ws = new WebSocket(`ws://${window.location.hostname}:81/`);
        let oauthToken = localStorage.getItem('oauth_token');

        ws.onopen = () => {
            console.log('WebSocket connected');
            document.getElementById('wifi-status').classList.add('connected');
            document.getElementById('wifi-status').classList.remove('disconnected');
            document.getElementById('wifi-status').textContent = 'WiFi: Connected';
        };

        ws.onclose = () => {
            console.log('WebSocket disconnected');
            document.getElementById('wifi-status').classList.add('disconnected');
            document.getElementById('wifi-status').classList.remove('connected');
            document.getElementById('wifi-status').textContent = 'WiFi: Disconnected';
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'status') {
                updateStatus(data.status);
            } else if (data.type === 'progress') {
                updateProgress(data.progress);
            }
        };

        function updateStatus(status) {
            const bleStatus = document.getElementById('ble-status');
            const authStatus = document.getElementById('auth-status');

            if (status.bleConnected) {
                bleStatus.classList.add('connected');
                bleStatus.classList.remove('disconnected');
                bleStatus.textContent = 'Bluetooth: Connected';
            } else {
                bleStatus.classList.add('disconnected');
                bleStatus.classList.remove('connected');
                bleStatus.textContent = 'Bluetooth: Disconnected';
            }

            if (status.authenticated) {
                authStatus.classList.add('connected');
                authStatus.classList.remove('disconnected');
                authStatus.textContent = 'Auth: Verified';
            } else {
                authStatus.classList.add('disconnected');
                authStatus.classList.remove('connected');
                authStatus.textContent = 'Auth: Not Verified';
            }
        }

        function updateProgress(progress) {
            const progressPercent = document.getElementById('progress-percent');
            const wordsTyped = document.getElementById('words-typed');
            const progressFill = document.getElementById('progress-fill');

            progressPercent.textContent = `${progress.percent}%`;
            wordsTyped.textContent = progress.words;
            progressFill.style.width = `${progress.percent}%`;
        }

        function setSpeed(wpm) {
            document.getElementById('wpm-input').value = wpm;
        }

        function uploadDoc() {
            const docLink = document.getElementById('doc-link').value;
            const wpm = document.getElementById('wpm-input').value;

            if (!docLink || !wpm) {
                alert('Please enter a valid Google Doc link and WPM.');
                return;
            }

            const payload = {
                type: 'upload',
                docLink: docLink,
                wpm: parseInt(wpm),
                token: oauthToken
            };

            ws.send(JSON.stringify(payload));

            const uploadStatus = document.getElementById('upload-status');
            uploadStatus.style.display = 'block';
            uploadStatus.classList.remove('success', 'error');
            uploadStatus.textContent = 'Uploading document...';

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'uploadStatus') {
                    if (data.status === 'success') {
                        uploadStatus.classList.add('success');
                        uploadStatus.textContent = 'Document uploaded successfully!';
                    } else {
                        uploadStatus.classList.add('error');
                        uploadStatus.textContent = 'Failed to upload document.';
                    }
                }
            };
        }
    </script>
</body>
</html>

